<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Full Production View</title>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fomantic-ui@2.9.4/dist/semantic.min.css">
    <script src="https://cdn.jsdelivr.net/npm/fomantic-ui@2.9.4/dist/semantic.min.js"></script>
    <!-- âœ… Load React and ReactDOM -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>

    <!-- Babel CDN to transpile JSX -->
    <!-- <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.26.5/babel.min.js"
        integrity="sha512-Y37Caenc5CZqwSMwWZj+5uxkB3Loc9yJNHvb+eSwEsT6nhURSrPZo39vTnb5g8UvOGCNXRbQ+xQvnqr2rR9nRw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- React Router DOM -->
    <script src="https://unpkg.com/react-router-dom@6/umd/react-router-dom.development.js" crossorigin></script>

    <!-- CDN for Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="text/babel" src="components_jsx/orderChart.js"></script>
    <script type="text/JavaScript" src="components_jsx/js/spMethod.js"></script>
</head>

<body>
    <div id="root"></div>



    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        const getRunRates = async () => {
            await main.fetchSharePointData('RunRates', 'runRates', false)
                .then(e => {
                    localStorage.setItem('runRates', e.value[0].fields.runRates);
                })
                .catch(err => console.log(err));
            return "Rates_Ready";
        }

        getRunRates().then(e => console.log(e)).catch(err => err)

        const FullView = () => {
            const [data, setData] = useState({
                goal: 0,
                progress: 0,
                remaining: 0,
                gpDataInput: null,
                modelId: '',
                selectedNumber: '',
                departmentName: ''

            });
            let workOrder = null

            const r = Array.isArray(data.gpDataInput?.reports)

            if (r) {

                data.gpDataInput.reports.forEach(item => {
                    const fields = item.fields;
                    // Find all workOrder IDs dynamically
                    const workOrderIds = Object.values(fields)
                        .filter(v => typeof v === "string")            // only check stringified JSON fields
                        .map(v => {
                            try {
                                const parsed = JSON.parse(v);
                                const dName = data.departmentName.includes('line') ? data.departmentName + data.selectedNumber : data.departmentName;
                                const nameMatch = parsed?.assignedTo?.department === dName;
                                const modelMatch = parsed?.product?.id === data.modelId;
                                if (nameMatch && modelMatch) return parsed?.workOrder?.id || null;
                            } catch {
                                return null; // ignore non-JSON fields
                            }
                        })
                        .filter(Boolean); // remove null values

                    workOrder = workOrderIds[0];

                })
            }

            // Listen for messages from the main window
            useEffect(() => {
                const handleMessage = (event) => {
                    if (event.data?.type === "UPDATE_FULL_VIEW") {
                        setData(event.data.payload);
                        localStorage.setItem("fullViewData", JSON.stringify(event.data.payload));
                    }
                };

                window.addEventListener("message", handleMessage);

                // Load last known data from localStorage (for refresh persistence)
                const stored = localStorage.getItem("fullViewData");
                if (stored) setData(JSON.parse(stored));

                return () => window.removeEventListener("message", handleMessage);
            }, []);


            const [activeTab, setActiveTab] = useState("chart"); // default tab
            const [aBlod, setBlob] = useState(); // default tab
            

            return (
                <div className="ui container" style={{ padding: "20px" }}>
                    <div className="ui clearing segment   padded">
                        <h1 className="ui header huge">Order Progress Dashboard</h1>

                        <h3 className="ui header sub header" style={{ marginTop: "0.5em" }}>
                            Order: {workOrder || "N/A"}
                        </h3>
                        <h3 className="ui header sub header" style={{ marginTop: "0.5em" }}>
                            Model: {data.modelId || "N/A"}
                        </h3>
                        <h3 className="ui header sub header" style={{ marginTop: "0.5em" }}>
                            Department: {data.departmentName || "N/A"}
                        </h3>

                        <button
                            className="ui right floated red button"
                            onClick={() => window.close()}
                        >
                            Close
                        </button>
                    </div>

                    {/* TABS HEADER */}
                    <div className="ui top attached tabular menu">
                        <a
                            className={`item ${activeTab === "chart" ? "active" : ""}`}
                            onClick={() => setActiveTab("chart")}
                        >
                            ðŸ“Š Chart
                        </a>
                        <a
                            className={`item ${activeTab === "drawing" ? "active" : ""}`}
                            onClick={() => setActiveTab("drawing")}
                        >
                            ðŸ§© eDrawing
                        </a>
                    </div>

                    {/* TABS CONTENT */}
                    <div className="ui bottom attached segment">
                        {activeTab === "chart" && (
                            <>
                                <OrderChartComponent
                                    modelId={data.modelId}
                                    departmentName={data.departmentName}
                                    selectedNumber={data.selectedNumber}
                                    progress={data.progress}
                                    gpDataInput={data.gpDataInput}
                                />

                                <div className="ui divider"></div>

                                <div className="ui three statistics">
                                    <div className="ui statistic teal">
                                        <div className="value">{data.goal}</div>
                                        <div className="label">Goal</div>
                                    </div>

                                    <div className="ui statistic blue">
                                        <div className="value">{data.progress}</div>
                                        <div className="label">Progress</div>
                                    </div>

                                    <div className="ui statistic orange">
                                        <div className="value">{data.remaining}</div>
                                        <div className="label">Remaining</div>
                                    </div>
                                </div>

                                <div className="ui segment">
                                    <p>This view updates live when the main page changes data.</p>
                                    <p>
                                        If you refresh this tab, it reloads the last known values from
                                        localStorage.
                                        type here

                                    </p>
                                </div>
                            </>
                        )}

                        {activeTab === "drawing" && (
                            <div style={{ height: "85vh", display: "flex", flexDirection: "column" }}>
                                <div className="ui segment">
                                    <button
                                        className="ui blue button"
                                        onClick={async () => {
                                            try {
                                                // Open a file picker (PDF only)
                                                const [fileHandle] = await window.showOpenFilePicker(/* {
                                                    types: [
                                                        {
                                                            description: "PDF Files",
                                                            accept: { "application/pdf": [".pdf"] },
                                                        },
                                                    ],
                                                    multiple: false, // only one file
                                                } */);

                                                const file = await fileHandle.getFile();
                                                const blobURL = URL.createObjectURL(file);

                                                // Set iframe src
                                               // const iframe = document.getElementById("drawingFrame");
                                              //   iframe.src = blobURL;
                                                setBlob(blobURL)
                                            } catch (err) {
                                                console.error(err);
                                                alert("File selection was cancelled or failed.");
                                            }
                                        }}
                                    >
                                        ðŸ“‚ Open File
                                    </button>
                                </div>

                                <iframe
                                    id="drawingFrame"
                                    src={aBlod}
                                    title="PDF Viewer"
                                    width="100%"
                                    height="100%"
                                    style={{ border: "none", flexGrow: 1 }}
                                ></iframe>
                            </div>
                        )}


                    </div>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById("root")).render(<FullView />);
    </script>
</body>

</html>

